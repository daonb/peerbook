---
id: hy9ua
name: webscokets gorilla server
file_version: 1.0.2
app_version: 0.7.10-0
file_blobs:
  main.go: 800a220cb6000913d2f137d46b61ef5ac5515500
  conn.go: b4af937cdb06fdd0ee60cbfc5f0d422ddc9d1e92
---

This is where the server starts
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ðŸ“„ main.go
```go
â¬œ 693    
â¬œ 694    	httpServerExitDone := &sync.WaitGroup{}
â¬œ 695    	httpServerExitDone.Add(1)
ðŸŸ© 696    	srv := startHTTPServer(*addr, httpServerExitDone)
â¬œ 697    	// Setting up signal capturing
â¬œ 698    	stop = make(chan os.Signal, 1)
â¬œ 699    	signal.Notify(stop, os.Interrupt)
```

<br/>

the web socket endpoint http handler and the upgrade call that turn an HTTP to a WebSocket.
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ðŸ“„ conn.go
```go
â¬œ 141    func serveWs(w http.ResponseWriter, r *http.Request) {
â¬œ 142    	q := r.URL.Query()
â¬œ 143    	Logger.Infof("Got a new peer request: %v", q)
â¬œ 144    	conn, err := ConnFromQ(q)
â¬œ 145    	if err != nil {
â¬œ 146    		Logger.Warnf("Refusing a bad request: %s", err)
â¬œ 147    		http.Error(w, err.Error(), http.StatusBadRequest)
â¬œ 148    		return
â¬œ 149    	}
â¬œ 150    
ðŸŸ© 151    	conn.WS, err = upgrader.Upgrade(w, r, nil)
ðŸŸ© 152    
â¬œ 153    	if err != nil {
â¬œ 154    		Logger.Errorf("Failed to upgrade socket: %w", err)
â¬œ 155    	}
```

<br/>

reading json
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ðŸ“„ conn.go
```go
â¬œ 47     	go c.subscribe(ctx)
â¬œ 48     	go c.pinger(ctx)
â¬œ 49     	for {
ðŸŸ© 50     		message := make(map[string]interface{})
ðŸŸ© 51     		err := c.WS.ReadJSON(&message)
â¬œ 52     		if err != nil {
â¬œ 53     			Logger.Info("Exiting read pump on error: %s", err)
â¬œ 54     			break
```

<br/>

Writing a message
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ðŸ“„ conn.go
```go
â¬œ 82     				Logger.Errorf("Got a bad message to send")
â¬œ 83     				return
â¬œ 84     			}
ðŸŸ© 85     			c.WS.SetWriteDeadline(time.Now().Add(writeWait))
ðŸŸ© 86     			err := c.WS.WriteMessage(websocket.TextMessage, message)
â¬œ 87     			if err != nil {
â¬œ 88     				if websocket.IsUnexpectedCloseError(err,
â¬œ 89     					websocket.CloseGoingAway, websocket.CloseAbnormalClosure) {
```

<br/>

Long living connection should send a ping message every X seconds
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ðŸ“„ conn.go
```go
â¬œ 97     				Logger.Info("Breaking on nil WS")
â¬œ 98     				break loop
â¬œ 99     			}
ðŸŸ© 100    			c.WS.SetWriteDeadline(time.Now().Add(writeWait))
ðŸŸ© 101    			err := c.WS.WriteMessage(websocket.PingMessage, nil)
â¬œ 102    			if err != nil {
â¬œ 103    				if websocket.IsUnexpectedCloseError(err,
â¬œ 104    					websocket.CloseGoingAway, websocket.CloseAbnormalClosure) {
```

<br/>

and they also need a pong handler to extend the read deadline
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ðŸ“„ conn.go
```go
â¬œ 38     // reads from this goroutine.
â¬œ 39     func (c *Conn) readPump() {
â¬œ 40     	c.WS.SetReadLimit(maxMessageSize)
ðŸŸ© 41     	c.WS.SetReadDeadline(time.Now().Add(pongWait))
ðŸŸ© 42     	c.WS.SetPongHandler(func(string) error {
ðŸŸ© 43     		c.WS.SetReadDeadline(time.Now().Add(pongWait))
ðŸŸ© 44     		return nil
ðŸŸ© 45     	})
â¬œ 46     	ctx, cancel := context.WithCancel(context.Background())
â¬œ 47     	go c.subscribe(ctx)
â¬œ 48     	go c.pinger(ctx)
```

<br/>

This file was generated by Swimm. [Click here to view it in the app](https://app.swimm.io/repos/Z2l0aHViJTNBJTNBcGVlcmJvb2slM0ElM0F0dXppZw==/docs/hy9ua).